---
marp: true
theme: default
paginate: true
backgroundColor: #1a1a2e
color: #eaeaea
style: |
  section {
    font-family: 'Pretendard', 'Apple SD Gothic Neo', sans-serif;
  }
  h1 {
    color: #00d4ff;
  }
  h2 {
    color: #00d4ff;
  }
  code {
    background-color: #16213e;
  }
  strong {
    color: #ff6b6b;
  }
  table {
    font-size: 0.8em;
  }
  .columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
---

# K8s ìŠ¤ì¼€ì¤„ëŸ¬ Deep Dive

ë‚´ë¶€ ë™ì‘ ì›ë¦¬ë¶€í„° Race Conditionê¹Œì§€

---

# ğŸ¤” ì§ˆë¬¸

Podë¥¼ ìƒì„±í•˜ë©´ **ì–´ë–¤ ë…¸ë“œ**ì— ë°°ì¹˜ë ê¹Œ?

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-app
spec:
  containers:
  - name: app
    image: nginx
    resources:
      requests:
        memory: "128Mi"
        cpu: "500m"
```

---

# ëª©ì°¨

1. ìŠ¤ì¼€ì¤„ë§ ê¸°ë³¸ êµ¬ì¡°
2. Scheduling Framework
3. Scheduling Queue
4. Preemption Deep Dive
5. ì„±ëŠ¥ íŠœë‹
6. ìŠ¤ì¼€ì¤„ëŸ¬ì˜ í•œê³„

---

<!-- _class: lead -->
# 1. ìŠ¤ì¼€ì¤„ë§ ê¸°ë³¸ êµ¬ì¡°

---

# 3ë‹¨ê³„ë¡œ ì´í•´í•˜ê¸°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚   Pending Pod                                           â”‚
â”‚       â”‚                                                 â”‚
â”‚       â–¼                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚  Filter   â”‚ â”€â–¶ â”‚   Score   â”‚ â”€â–¶ â”‚   Bind    â”‚      â”‚
â”‚   â”‚  (í•„í„°ë§)  â”‚    â”‚  (ì ìˆ˜í™”)  â”‚    â”‚  (ë°”ì¸ë”©)  â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                         â”‚
â”‚   5ê°œ ë…¸ë“œ â†’ 2ê°œ    ê° ë…¸ë“œ ì ìˆ˜    ìµœê³  ì ìˆ˜ ë…¸ë“œ ì„ íƒ   â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# Filter ë‹¨ê³„

ì¡°ê±´ì— ë§ì§€ ì•ŠëŠ” ë…¸ë“œë¥¼ **ì œì™¸**

| Filter | ì—­í•  |
|--------|------|
| `NodeResourcesFit` | CPU/Memory ì¶©ë¶„í•œì§€ |
| `NodeAffinity` | nodeSelector, nodeAffinity ë§Œì¡±í•˜ëŠ”ì§€ |
| `TaintToleration` | Taintë¥¼ Tolerationí•˜ëŠ”ì§€ |
| `PodTopologySpread` | í† í´ë¡œì§€ ë¶„ì‚° ì¡°ê±´ ë§Œì¡±í•˜ëŠ”ì§€ |

```
Node A âœ“  Node B âœ—  Node C âœ“  Node D âœ—  Node E âœ“
         (taint)              (ë¦¬ì†ŒìŠ¤ ë¶€ì¡±)
```

---

# Score ë‹¨ê³„

ë‚¨ì€ ë…¸ë“œì— **ì ìˆ˜** ë¶€ì—¬ (0~100)

```
Node A: 75ì   â† LeastAllocated (ì—¬ìœ  ë¦¬ì†ŒìŠ¤ ë§ìŒ)
Node C: 45ì 
Node E: 60ì 
```

**NodeResourcesFit ìŠ¤ì½”ì–´ë§ ì „ëµ:**

| ì „ëµ | ì„¤ëª… | ìš©ë„ |
|------|------|------|
| `LeastAllocated` | ì—¬ìœ  ë§ì„ìˆ˜ë¡ ë†’ì€ ì ìˆ˜ | ë¶€í•˜ ë¶„ì‚° (ê¸°ë³¸ê°’) |
| `MostAllocated` | ê½‰ ì°°ìˆ˜ë¡ ë†’ì€ ì ìˆ˜ | ë…¸ë“œ ìˆ˜ ìµœì†Œí™”, ë¹„ìš© ì ˆê° |

---

# Bind ë‹¨ê³„

ìµœê³  ì ìˆ˜ ë…¸ë“œì— **ë°”ì¸ë”©**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Scheduler   â”‚ â”€â”€â”€â”€â”€â”€â–¶ â”‚  API Server  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
        pod.spec.nodeName = "node-a"
                               â”‚
                               â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   Node A     â”‚
                         â”‚   (kubelet)  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

<!-- _class: lead -->
# 2. Scheduling Framework

---

# 15ê°œ Extension Point

```
PreEnqueue â”€â–¶ [Queue] â”€â–¶ PreFilter â”€â–¶ Filter â”€â–¶ PostFilter
                              â”‚
                              â–¼
                         PreScore â”€â–¶ Score â”€â–¶ NormalizeScore
                              â”‚
                              â–¼
                          Reserve â”€â–¶ Permit â”€â–¶ PreBind â”€â–¶ Bind â”€â–¶ PostBind
```

**ì™œ ì´ë ‡ê²Œ ë§ì„ê¹Œ?**
â†’ ì»¤ìŠ¤í…€ ìŠ¤ì¼€ì¤„ëŸ¬ í”ŒëŸ¬ê·¸ì¸ì„ ì‰½ê²Œ ë¼ì›Œë„£ê¸° ìœ„í•´

---

# Scheduling Cycle vs Binding Cycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Scheduling Cycle (Serial)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚PreFilterâ”‚ Filter  â”‚PostFilterâ”‚PreScore â”‚  Score  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                         â†“                                   â”‚
â”‚  â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€   â”‚
â”‚                         â†“                                   â”‚
â”‚  Binding Cycle (Parallel)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ Reserve â”‚  Permit â”‚ PreBind â”‚  Bind   â”‚  â† goroutine    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ì™œ ë¶„ë¦¬?** â†’ BindëŠ” API Server í˜¸ì¶œì´ë¼ ëŠë¦¼. ë³‘ë ¬ë¡œ ì²˜ë¦¬í•´ì•¼ throughput í™•ë³´

---

<!-- _class: lead -->
# 3. Scheduling Queue

---

# 3ê°œì˜ í

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   ìƒˆ Pod â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚    ActiveQ      â”‚ â”€â”€â”€â”€â–¶ ìŠ¤ì¼€ì¤„ë§ ì‹œë„
                    â”‚  (heap, ìš°ì„ ìˆœìœ„) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                      ìŠ¤ì¼€ì¤„ë§ ì‹¤íŒ¨
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    BackoffQ     â”‚ â”€â”€â”€â”€â–¶ ëŒ€ê¸° í›„ ActiveQë¡œ
                    â”‚  (ì§€ìˆ˜ ë°±ì˜¤í”„)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                      ê³„ì† ì‹¤íŒ¨ (ì„ê³„ê°’ ì´ˆê³¼)
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Unschedulable  â”‚ â”€â”€â”€â”€â–¶ í´ëŸ¬ìŠ¤í„° ë³€ê²½ì‹œ ë³µê·€
                    â”‚   Pod Pool      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# QueueingHint (v1.32 GA)

**ë¬¸ì œ:** Unschedulable Podë¥¼ ì–¸ì œ ë‹¤ì‹œ ì‹œë„í• ê¹Œ?

**ê¸°ì¡´:** ì•„ë¬´ ì´ë²¤íŠ¸ë‚˜ ë°œìƒí•˜ë©´ ì¼ë‹¨ ActiveQë¡œ ì´ë™ â†’ **ë¹„íš¨ìœ¨**

**QueueingHint:** ì´ë²¤íŠ¸ë³„ë¡œ "ì´ Podê°€ ìŠ¤ì¼€ì¤„ ê°€ëŠ¥í•´ì§ˆ ìˆ˜ ìˆë‚˜?" íŒë‹¨

```go
// ë°˜í™˜ê°’
const (
    QueueSkip         // ì´ ì´ë²¤íŠ¸ë¡œëŠ” ì•ˆ ë¨, ìŠ¤í‚µ
    Queue             // ê°€ëŠ¥ì„± ìˆìŒ, íë¡œ ì´ë™
    QueueImmediately  // í™•ì‹¤í•¨, ì¦‰ì‹œ ì´ë™
)
```

---

<!-- _class: lead -->
# 4. Preemption Deep Dive

---

# Preemptionì´ë€

ë†’ì€ ìš°ì„ ìˆœìœ„ Podê°€ **ë‚®ì€ ìš°ì„ ìˆœìœ„ Podë¥¼ ì«“ì•„ë‚´ê³ ** ìë¦¬ í™•ë³´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node A (capacity: 4 CPU)              â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Pod Low  â”‚  â”‚ Pod Low  â”‚  â† 2 CPU  â”‚
â”‚  â”‚ (pri:10) â”‚  â”‚ (pri:10) â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                        â”‚
â”‚  High Priority Pod (pri:100) ìš”ì²­: 3CPU â”‚
â”‚        â”‚                               â”‚
â”‚        â–¼                               â”‚
â”‚  Low Pod 1ê°œ evict â†’ High Pod ë°°ì¹˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# âš ï¸ ì œí•œì‚¬í•­ 1: Inter-Pod Affinity

ë†’ì€ ìš°ì„ ìˆœìœ„ Podê°€ ë‚®ì€ ìš°ì„ ìˆœìœ„ Podì— **affinity**ê°€ ìˆìœ¼ë©´?

```
cache-pod (priority: 10)  â†â”€â”€â”€ affinity â”€â”€â”€  web-pod (priority: 100)
```

**ë¬¸ì œ:**
1. web-pod ìŠ¤ì¼€ì¤„ë§ ì‹œë„
2. preemption ì‹œë®¬ë ˆì´ì…˜: cache-pod ì œê±°í•˜ë©´ ìë¦¬ ìƒê¹€
3. ê·¼ë° cache-pod ì œê±°í•˜ë©´ affinity ë§Œì¡± ë¶ˆê°€
4. **ê²°ê³¼: web-podëŠ” ì˜ì›íˆ Pending**

**í•´ê²°ì±…:** affinity ëŒ€ìƒ Podì˜ ìš°ì„ ìˆœìœ„ë¥¼ ê°™ê±°ë‚˜ ë†’ê²Œ ì„¤ì •

---

# âš ï¸ ì œí•œì‚¬í•­ 2: Cross-Node Preemption ë¶ˆê°€

**ë‹¤ë¥¸ ë…¸ë“œ**ì˜ PodëŠ” ì«“ì•„ë‚´ì§€ ì•ŠìŒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Node 1     â”‚     â”‚   Node 2     â”‚
â”‚              â”‚     â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  (ë¹ˆ ê³µê°„)   â”‚
â”‚  â”‚ pod-a  â”‚  â”‚     â”‚              â”‚
â”‚  â”‚pri:10  â”‚  â”‚     â”‚              â”‚
â”‚  â”‚anti-   â”‚  â”‚     â”‚  web-pod     â”‚
â”‚  â”‚affinityâ”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â–¶ ëª» ë“¤ì–´ê°  â”‚
â”‚  â”‚to web  â”‚  â”‚     â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         zone-a

pod-aë¥¼ ì«“ì•„ë‚´ë©´ í•´ê²°ë˜ëŠ”ë°, ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” Node 1ì„ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
```

---

# âš ï¸ ì œí•œì‚¬í•­ 3: nominatedNodeName Race

```
Timeline
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶

T1: Pod P ìŠ¤ì¼€ì¤„ë§ ì‹¤íŒ¨, preemption ì‹œì‘
    â”‚
T2: â”‚  ìŠ¤ì¼€ì¤„ëŸ¬ê°€ Node N ì„ íƒ, nominatedNodeName=N ì„¤ì • ìš”ì²­
    â”‚
T3: â”‚  ê·¸ ì‚¬ì´ Pod Qê°€ ìƒì„±ë¨
    â”‚     â”‚
T4: â”‚     â””â”€â–¶ Pod Qê°€ Node Nì— ìŠ¤ì¼€ì¤„ë§ë¨ (ìë¦¬ ìˆì—ˆìœ¼ë‹ˆê¹Œ)
    â”‚
T5: â””â”€â–¶ Pod Pì˜ nominatedNodeName=N ì„¤ì • ì™„ë£Œ
         í•˜ì§€ë§Œ ì´ë¯¸ ìë¦¬ ì—†ìŒ!

ê²°ê³¼: Node Nì€ Pë¥¼ ìœ„í•´ "ì˜ˆì•½"ëë‹¤ê³  ìƒê°í•´ì„œ
      ë‹¤ë¥¸ ì‘ì€ Podë“¤ë„ ì•ˆ ë“¤ì–´ê° â†’ ë¦¬ì†ŒìŠ¤ ë‚­ë¹„
```

---

# âš ï¸ ì œí•œì‚¬í•­ 4: Graceful Termination ì¤‘ ë¼ì–´ë“¤ê¸°

victim Pod ì¢…ë£Œ ëŒ€ê¸° ì¤‘ (ê¸°ë³¸ 30ì´ˆ) **ë‹¤ë¥¸ Podê°€ ë¼ì–´ë“¦**

```
T1: Pod P (pri:100) preemption ì‹œì‘, victim ì¢…ë£Œ ìš”ì²­
    â”‚
T2: â”‚  victim ì¢…ë£Œ ì¤‘... (30ì´ˆ ëŒ€ê¸°)
    â”‚
T3: â”‚  Pod Q (pri:200) ìƒì„±ë¨
    â”‚
T4: â”‚  victim ì¢…ë£Œ ì™„ë£Œ, ìë¦¬ ìƒê¹€
    â”‚     â”‚
T5: â”‚     â””â”€â–¶ Qê°€ ë¨¼ì € ìŠ¤ì¼€ì¤„ë§ë¨ (ë” ë†’ì€ ìš°ì„ ìˆœìœ„)
    â”‚
T6: â””â”€â–¶ PëŠ” ë‹¤ì‹œ Pending ìƒíƒœ

ì™„í™”ì±…: ë‚®ì€ ìš°ì„ ìˆœìœ„ Podì— terminationGracePeriodSeconds: 0
```

---

# âš ï¸ ì œí•œì‚¬í•­ 5: PDBëŠ” Best-Effort

PodDisruptionBudgetì„ **ì¡´ì¤‘í•˜ë ¤ê³  ë…¸ë ¥**í•˜ì§€ë§Œ ë³´ì¥ ì•„ë‹˜

**Race Condition ì‹œë‚˜ë¦¬ì˜¤:**
```
PDB: minAvailable: 2
í˜„ì¬ Pod: 3ê°œ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Scheduler A â”‚     â”‚ Scheduler B â”‚  (HA êµ¬ì„±)
â”‚             â”‚     â”‚             â”‚
â”‚ "1ê°œ evict  â”‚     â”‚ "1ê°œ evict  â”‚
â”‚  ê°€ëŠ¥í•˜ë„¤"   â”‚     â”‚  ê°€ëŠ¥í•˜ë„¤"   â”‚
â”‚      â”‚      â”‚     â”‚      â”‚      â”‚
â”‚      â–¼      â”‚     â”‚      â–¼      â”‚
â”‚  evict 1ê°œ  â”‚     â”‚  evict 1ê°œ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ê²°ê³¼: Pod 1ê°œë§Œ ë‚¨ìŒ (minAvailable: 2 ìœ„ë°˜!)
```
ref: kubernetes/kubernetes#91492

---

# âš ï¸ ì œí•œì‚¬í•­ 6: Priority Inflation

ëª¨ë“  Podê°€ ë†’ì€ ìš°ì„ ìˆœìœ„ë©´ **preemption ë¬´ì˜ë¯¸**

**í•´ê²°ì±…: ResourceQuotaë¡œ ì œí•œ**

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: high-priority-quota
spec:
  hard:
    pods: "10"  # high-priority PodëŠ” ìµœëŒ€ 10ê°œ
  scopeSelector:
    matchExpressions:
    - operator: In
      scopeName: PriorityClass
      values: ["high-priority"]
```

---

<!-- _class: lead -->
# 5. ì„±ëŠ¥ íŠœë‹

---

# percentageOfNodesToScore

**ëª¨ë“  ë…¸ë“œë¥¼ ìŠ¤ì½”ì–´ë§í•˜ë©´ ëŠë¦¼** â†’ ì¼ì • ë¹„ìœ¨ë§Œ í™•ì¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  í´ëŸ¬ìŠ¤í„° í¬ê¸°     â”‚  ê¸°ë³¸ê°’              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  100 ë…¸ë“œ         â”‚  50%                â”‚
â”‚  500 ë…¸ë“œ         â”‚  20%                â”‚
â”‚  5000+ ë…¸ë“œ       â”‚  10%                â”‚
â”‚  ìµœì†Œê°’           â”‚  5% (í•˜ë“œì½”ë”©)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```yaml
apiVersion: kubescheduler.config.k8s.io/v1
kind: KubeSchedulerConfiguration
percentageOfNodesToScore: 50
```

---

# ë…¸ë“œ ìˆœíšŒ ìµœì í™”

**ê°™ì€ ë…¸ë“œë§Œ ì„ íƒë˜ëŠ” ê²ƒ ë°©ì§€**

```go
// ì‹œì‘ ì¸ë±ìŠ¤ë¥¼ ëœë¤í•˜ê²Œ
startIndex := rand.Intn(len(nodes))

// round-robinìœ¼ë¡œ ìˆœíšŒ
for i := 0; i < numNodesToCheck; i++ {
    idx := (startIndex + i) % len(nodes)
    checkNode(nodes[idx])
}
```

50% ìŠ¤ì½”ì–´ë§ì´ì–´ë„ **ë§¤ë²ˆ ë‹¤ë¥¸ ë…¸ë“œ ì§‘í•©** ê²€ì‚¬

---

<!-- _class: lead -->
# 6. ìŠ¤ì¼€ì¤„ëŸ¬ì˜ í•œê³„

---

# ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ëª¨ë¥´ëŠ” ê²ƒë“¤

| í•­ëª© | ì„¤ëª… |
|------|------|
| **NUMA í† í´ë¡œì§€** | kubeletì˜ Topology Managerê°€ ì²˜ë¦¬. ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” ëª¨ë¦„ |
| **GPU ì„¸ë¶€ ì •ë³´** | `nvidia.com/gpu: 1`ë§Œ ì•. ì–´ë–¤ GPUì¸ì§€ ëª¨ë¦„ |
| **Ephemeral Storage** | ìš”ì²­ëŸ‰ë§Œ ë´„. ì‹¤ì œ ì‚¬ìš©ëŸ‰ ëª¨ë¦„ |
| **ì‹¤ì‹œê°„ ë¦¬ì†ŒìŠ¤** | ìºì‹œëœ ì •ë³´ ì‚¬ìš©. ìˆ˜ ì´ˆ ì§€ì—° ìˆìŒ |

**ê²°ê³¼:** ìŠ¤ì¼€ì¤„ë§ ì„±ê³µ â†’ kubelet Admit ì‹¤íŒ¨ ê°€ëŠ¥

```
Scheduler: "Node Aì— ë°°ì¹˜!"
Kubelet: "NUMA ì¡°ê±´ ì•ˆ ë§ëŠ”ë°ìš”" â†’ Pod ê±°ë¶€
```

---

# ì •ë¦¬

1. **3ë‹¨ê³„ ê¸°ë³¸ êµ¬ì¡°:** Filter â†’ Score â†’ Bind

2. **Scheduling Framework:** 15ê°œ extension pointë¡œ ì»¤ìŠ¤í„°ë§ˆì´ì§•

3. **Queue êµ¬ì¡°:** ActiveQ â†’ BackoffQ â†’ Unschedulable Pool

4. **Preemption ì£¼ì˜ì‚¬í•­:**
   - nominatedNodeName race condition
   - PDBëŠ” best-effort
   - Cross-node preemption ì•ˆ ë¨

5. **ì„±ëŠ¥:** percentageOfNodesToScoreë¡œ íŠœë‹

6. **í•œê³„:** NUMA, GPU ìƒì„¸ ì •ë³´ëŠ” ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ëª¨ë¦„

---

<!-- _class: lead -->
# Q&A

---

# References

- [Kubernetes Scheduler](https://kubernetes.io/docs/concepts/scheduling-eviction/kube-scheduler/)
- [Scheduling Framework](https://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework/)
- [Pod Priority and Preemption](https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/)
- [kubernetes/kubernetes #91492](https://github.com/kubernetes/kubernetes/issues/91492)
