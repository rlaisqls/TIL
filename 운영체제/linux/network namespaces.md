# π§ network namespace

μ»¨ν…μ΄λ„λ” [namespace](namespaceμ™€β€…cgroup.md)λ¥Ό μ‚¬μ©ν•μ—¬ κ°™μ€ host μ•μ—μ„ μμ›μ„ κ²©λ¦¬ν•λ‹¤. 

network namespaceλ” λ„μ»¤μ™€ κ°™μ€ μ»¨ν…μ΄λ„μ—μ„ λ„¤νΈμ›ν¬ κ²©λ¦¬λ¥Ό κµ¬ν„ν•κΈ° μ„ν•΄ μ“°μΈλ‹¤. κΈ°λ³Έμ μΌλ΅ νΈμ¤νΈλ” μ™Έλ¶€ λ„¤νΈμ›ν¬μ™€ μ—°κ²°ν•κΈ° μ„ν• μΈν„°νμ΄μ¤μ™€ Routing Table, ARP Tableμ„ κ°€μ§€κ³  μλ”λ°, μ»¨ν…μ΄λ„λ¥Ό λ§λ“¤λ©΄ κ·Έ μ»¨ν…μ΄λ„μ— λ€ν• network namespaceκ°€ μƒμ„±λμ–΄μ„ νΈμ¤νΈμ λ„¤νΈμ›ν¬ μΈν„°νμ΄μ¤μ™€ μ™„μ „ν λ¶„λ¦¬λλ‹¤.

λ€μ‹ μ—, μ¶”κ°€μ μΌλ΅ **μ»¨ν…μ΄λ„ κ°κ°μ— κ°€μƒμ μΈν„°νμ΄μ¤μ™€ Routing Table, ARP Tableμ„ μ„¤μ •**ν•λ©΄ μ„¤μ •λ€λ΅ ν†µμ‹ μ„ ν•  μ μκ² λλ‹¤. νΈμ¤νΈμ—μ„λ” κ° λ„¤νΈμ›ν¬ μΈν„°νμ΄μ¤μ λ„¤νΈμ›ν¬ μ”μ†λ¥Ό ν™•μΈν•  μ μ—†μΌλ©°, κ° λ„¤μ„μ¤νμ΄μ¤λ„ νΈμ¤νΈκ°€ μ™Έλ¶€μ™€ ν†µμ‹ ν•κΈ° μ„ν•΄ μ“°λ” λ„¤νΈμ›ν¬ μ”μ†λ¥Ό ν™•μΈν•  μ μ—†λ‹¤.

## λ…λ Ήμ–΄

λ„¤μ„ μ¤νμ΄μ¤ λ©λ΅ λ³΄κΈ°
```js
ip netns
```

μΈν„°νμ΄μ¤ λ©λ΅ λ³΄κΈ°
```
ip link
```

λ„¤μ„μ¤νμ΄μ¤ λ‚΄λ¶€μ μΈν„°νμ΄μ¤ λ©λ΅ λ³΄κΈ°
```js
ip netns exec {namespace name} ip link
ip -n {namespace name} link
```

```js
arp
route
```

## λ‘ network namespaceλ¥Ό μ§μ ‘ μ—°κ²°ν•κΈ°

`red`μ™€ `blue`λΌλ” λ„¤νΈμ›ν¬ μΈν„°νμ΄μ¤λ¥Ό λ§λ“¤μ–΄λ†“μ•λ‹¤κ³  ν•΄λ³΄μ

λ‘ μΈν„°νμ΄μ¤λ¥Ό μ—°κ²°λ μƒνƒλ΅ μƒμ„±ν•λ‹¤. (μ•„μ§ μ΄ μΈν„°νμ΄μ¤κ°€ λ„¤μ„μ¤νμ΄μ¤μ™€ λ“±λ΅λμ§„ μ•μ•λ‹¤.)
```js
ip link add veth-red type veth peer name veth-blue
```

κ° μΈν„°νμ΄μ¤λ¥Ό λ„¤μ„μ¤νμ΄μ¤μ— λ“±λ΅ν•λ‹¤.
```js
ip link set veth-red netns red
ip link set veth-blue netns blue
```

λ„¤μ„μ¤νμ΄μ¤(μΈν„°νμ΄μ¤)μ— κ°€μƒ ipλ¥Ό μ§€μ •ν•λ‹¤.
```js
ip -n red addr add 192.168.15.1 veth-red
ip -n blue addr add 192.168.15.1 veth-blue
```

μΈν„°νμ΄μ¤κ°€ μ‹¤μ λ΅ μ‘λ™ν•  μ μλ„λ΅ ν™μ„±ν™”ν•λ‹¤.
```js
ip -n red link set veth-red up
ip -n blue link set veth-blue up
```

redμ—μ„ blueμ ipλ΅ pingμ„ λ³΄λ‚΄λ©΄ arp ν…μ΄λΈ”μ—μ„ ν•΄λ‹Ή νΈμ¤νΈλ¥Ό λ“±λ΅ν•΄λ†“μ€ κ²ƒμ„ λ³Ό μ μλ‹¤.
```js
ip netns exec red ping 192.168.15.2
ip netns exec
```

output
```js
Address        HWtype  HWaddress          Flags Mak  Iface
192.168.15.2   ether   ba:b0:6d:68:09:e9  C          veth-red
```

## κ°€μƒ switch λ§λ“¤κΈ°

μ„μ™€κ°™μ΄ μΈν„°νμ΄μ¤λ¥Ό μ§μ ‘ μ—°κ²°ν•μ§€ μ•κ³ , [λ„¤νΈμ›ν¬ μ¤μ„μΉ](https://ko.wikipedia.org/wiki/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC_%EC%8A%A4%EC%9C%84%EC%B9%98)λ¥Ό κ°€μƒμΌλ΅ κµ¬ν„ν•μ—¬ μ—°κ²°ν•λ” λ°©λ²•λ„ μλ‹¤. 

linux bridgeλ¥Ό ν†µν•΄ κ°€μƒ switchλ¥Ό κµ¬ν„ν•λ” λ°©λ²•μ„ μ•μ•„λ³΄μ.

μ°μ„ μ€ νΈμ¤νΈμ— λΈλ¦Ώμ§€ νƒ€μ…μ λ„¤νΈμ›ν¬ μΈν„°νμ΄μ¤λ¥Ό ν•λ‚ μ •μν•΄μ¤€λ‹¤.
```js
ip link add v-net-0 type bridge
ip link set deb v-net-0 up
```

μ΄ μΈν„°νμ΄μ¤λ” λΈλ¦Ώμ§€ νƒ€μ…μ΄κΈ° λ–„λ¬Έμ—, κ° λ„¤νΈμ›ν¬ λ„¤μ„μ¤νμ΄μ¤μ—μ„λ„ λ³΄κ³  μ ‘κ·Όν•  μ μλ‹¤. 

μΈν„°νμ΄μ¤λ¥Ό ν†µν•΄ μ¤μ„μΉμ™€ λ„¤μ„μ¤νμ΄μ¤λ¥Ό μ΄μ–΄μ£Όμ.

```js
ip link add veth-red type veth peer name veth-red-br
ip link set veth-red netns red
ip link set veth-red-br master v-net-0

ip link add veth-blue type veth peer name veth-blue-br
```

κ·Έλ¦¬κ³  λ„¤μ„μ¤νμ΄μ¤(μΈν„°νμ΄μ¤)μ— κ°€μƒ ipλ¥Ό μ§€μ •ν•κ³  ν™μ„±ν™”ν•λ‹¤.
```js
ip -n red addr add 192.168.15.1 veth-red
ip -n blue addr add 192.168.15.1 veth-blue
ip -n red link set veth-red up
ip -n blue link set veth-blue up
```

μ΄λ ‡κ² μ—¬λ¬ λ„¤μ„μ¤νμ΄μ¤λ¥Ό μ—°κ²°ν•΄μ£Όλ©΄, μ„λ΅ ν†µμ‹ ν•  μ μλ” μƒνƒκ°€ λλ‹¤. ν•μ§€λ§ μ—¬κΈ°κΉμ§€λ” κ° λ„¤μ„μ¤νμ΄μ¤λΌλ¦¬λ§ μ—°κ²°λμ–΄μλ” μƒνƒκΈ° λ•λ¬Έμ—, μ™Έλ¶€μ—μ„λ” μ΄ λ„¤μ„μ¤νμ΄μ¤μ— μ ‘κ·Όν•  λ°©λ²•μ΄ μ•„μ§ μ—†λ‹¤.

μ™Έλ¶€μ—μ„ λ„¤νΈμ›ν¬ λ„¤μ„μ¤νμ΄μ¤μ— μ ‘κ·Όν•  μ μλ„λ΅ ν•κΈ° μ„ν•΄μ„ , νΈμ¤νΈλ¥Ό κ±°μ³μ•Όν•λ‹¤. μ΄λ¥Ό μ„¤μ •ν•΄μ¤„ μ μλ„λ΅ ν•λ” κ²ƒμ΄ λ°”λ΅ iptableμ΄λ‹¤.

νΈμ¤νΈλ΅ λ“¤μ–΄μ¨ νΈλν”½μ„ μ–΄λ–¤ λ„¤νΈμ›ν¬λ΅ λ³΄λ‚Όμ§€ κµ¬λ¶„ν•κΈ° μ„ν•΄μ„ λ“¤μ–΄μ¨ ν¬νΈμ— λ”°λΌ λ§¤ν•‘ν•λ” λ°©μ‹μ„ μ‚¬μ©ν•λ” κ²ƒμ΄ λ€ν‘μ μ΄λ‹¤. μ—¬κΈ°μ„ dportμ™€ destination portλ¥Ό λ‹¤λ¥΄κ² μ„¤μ •ν•λ©΄, ν¬νΈν¬μ›λ”©μ΄ λλ‹¤.

```js
iptables -t nat -A PRESOUTING --dport 80 --to-destination 192.168.15.2:80 -j DNAT
```

μµμΆ…μ μΌλ΅ μ•„λμ™€ κ°™μ€ λ¨μ–‘μ΄ λλ‹¤.

<img src="https://user-images.githubusercontent.com/81006587/216491394-fa7e84e9-d1a8-437c-b5a6-2fd460f9532f.png" height=300px>