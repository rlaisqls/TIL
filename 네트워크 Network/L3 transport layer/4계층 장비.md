# 4계층 장비

- 4계층 장비는 TCP와 같이 4계층 헤더에 있는 정보를 기반으로 동작한다. 
- 4계층 이상에서 동작하는 로드 밸런서, 방화벽과 같은 장비를 세션 장비라 부른다.

- 세션 장비에서 고려해야할 요소는 다음과 같다. 
  - **세션 테이블**
    - 세션 장비는 세션 테이블 기반으로 운영된다.
    - 세션 정보를 저장, 확인하는 작업 전반을 이해해야 한다.
    - 세션 정보는 세션 테이블에 남아 있는 라이프타임이 존재한다. 
      <img width="269" alt="image" src="https://github.com/rlaisqls/TIL/assets/81006587/b0b6330f-d87d-4fc7-a8d0-9778715f0d9b">
  - **Symmetric(대칭)경로 요구**
    - Inbound와 Outbound 경로가 일치해야 한다.
    - 세션 동기화 또는 터널링(경로 보정)을 통해 해결할 수 있다.
      <img width="261" alt="image" src="https://github.com/rlaisqls/TIL/assets/81006587/e0e40add-2e9f-4623-8518-cdff0dc8b963">
  - **정보 변경(로드 밸런서의 경우)**
    - IP주소가 변경되며 확장된 1.7 로드 밸런서(ADC)는 애플리케이션 프로토콜 정보도 변경된다. 
  
이 밖에도 세션 장비의 여러 요소가 서비스에 영향을 미치기 때문에 네트워크 중간 위치에 세션을 기반으로 동작하는 방화벽, NAT, 로드밸런서와 같은 장비가 있다면 네트워크 인프라 뿐 아니라 시스템 설계와 애플리케이션 개발에도 세션 장비 고려가 필요하다. 

### 로드 밸런서

- 로드밸런서 - 서버나 장비의 부하를 분산하기 위해 사용하는 장비
- 4계층 이상에서 동작하면서 트래픽을 분산해주며 IP주소, 4계층 정보, 애플리케이션 정보를 확인 및 수정해주는 기능이 있다. 그래서 가장 많이 쓰이는 곳이 웹 서버 부하 분산이다. 
- 이러한 로드밸런서는 웹이나 애플리케이션 뿐아니라 FWLB(FireWall Load Bancing: 방화벽 로드밸런싱), VPNLB(VPN Load Balancing: VPN 로드 밸런싱)와 같이 다양한 서비스를 위해 사용될 수 있다.
- 로드밸런서는 동작하는 계층에 따라 4계층과 7계층으로 나뉜다.

### L4 스위치 

- 용어 그대로 4계층에서 동작하면서 로드 밸런서 기능이 있는 스위치이다.
- 내부 동작 방식은 4계층 로드밸런서지만 외형은 스위치처럼 여러 포트를 가지고 있다. 
- 다양한 네트워크 구성이 가능한 스위치형 로드 밸런서가 가장 대중화되어있다. 
- 부하 분산, 성능 최적화, 리다이렉션 기능을 제공한다.
    <img width="569" alt="image" src="https://github.com/rlaisqls/TIL/assets/81006587/5f03e7a6-4f5b-41eb-959a-8583b8e21808">

- L4스위치가 동작하려면 다음 4가지를 설정해야 한다. 
  - 가상 서버(Virtual Server) : 사용자가 바라보는 실제 서비스
  - 가상 IP(Virtual IP) : 사용자가 접근해야 하는 서비스 IP 주소
  - 리얼 서버(Real Server) : 실제 서비스를 수행하는 서버
  - 리얼 IP(Real IP) : 실제 서버의 IP
  
사용자는 L4스위치의 가상 IP를 목적지로 서비스를 요청하고 L4스위치가 목적지로 설정된 가상 IP를 리얼 IP로 다시 변경해 보내준다. 이 과정에서 부하를 어떤 방식으로 분산할지 결정할 수 있다. 

### ADC(Application Delivery Controller)

- ADC(Application Delivery Controller)는 애플리케이션 계층에서 동작하는 로드 밸런서다. 
- 애플리케이션 프로토콜의 헤더와 내용을 이해하고 동작한다. 
  - 부하 분산, 정보 수정, 정보 필터링이 가능하다.
- ADC는 이런 동작을 위해 프록시로 동작한다. 
- 대부분의 ADC는 L4스위치의 기능을 포함하고 있으며, 다음과 같은 기능을 제공 및 수행한다.
  - 로드 밸런싱 기능
  - 페일 오버(Failover, 장애극복 기능)
  - 리다이렉션(Redirection)
- 애플리케이션 프로토콜을 이해하고 최적화하는 기능도 제공한다. 
  - 캐싱(Caching), 압축(Compression), 콘텐츠 변환 및 재작성, 인코딩 변환
- 플러그인 형태로 보안 강화기능을 추가로 제공해서 다음과같은 기능을 제공한다. 
  - WAF(Web Application Firewall) 기능
  - HTML, XML 검증 및 변환 수행

---
참고
- [IT 엔지니어를 위한 네트워크 입문](https://m.yes24.com/Goods/Detail/93997435)